<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <title data-i18n="meta.contact.title">Contacto — Missael Rangel</title>
    <meta name="description" data-i18n="meta.contact.description" data-i18n-attr="content" />

    <script>
        (function () {
            var K = "site:lang";
            var saved = null;
            try { saved = localStorage.getItem(K); } catch (e) { }

            var nav = (navigator.language || "es").toLowerCase();
            var lang = (saved === "en" || saved === "es") ? saved : (nav.startsWith("es") ? "es" : "en");

            // Refleja el idioma en <html>
            var html = document.documentElement;
            html.classList.add("lang-" + lang);
            html.setAttribute("lang", lang);

            // Fuerza idioma de reCAPTCHA ANTES de cargar el script
            window.___grecaptcha_cfg = window.___grecaptcha_cfg || {};
            window.___grecaptcha_cfg.lang = (lang === "en" ? "en" : "es");

            // Inyecta el script de reCAPTCHA con ?hl=...
            var s = document.createElement("script");
            s.src = "https://www.google.com/recaptcha/api.js?hl=" + (lang === "en" ? "en" : "es");
            s.async = true;
            s.defer = true;
            document.head.appendChild(s);
        })();
    </script>


    <!-- Estilos -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32x32.png" />
    <link rel="stylesheet" href="assets/fonts/fontawesome-free-6.1.2-web/css/all.min.css" />
    <link rel="stylesheet" href="assets/fonts/poppins/poppins.css" />
    <link rel="stylesheet" href="assets/css/reset.css" />
    <link rel="stylesheet" href="assets/css/scroll.css" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/loader.css" />
    <link rel="stylesheet" href="assets/css/responsive.css" />

    <!-- i18n -->
    <script defer src="assets/js/translations.js"></script>
    <script defer src="assets/js/i18n.js"></script>

    <!-- Scripts -->
    <script defer src="assets/js/menu.js"></script>
    <script defer src="assets/js/map.js"></script>
</head>

<body>
    <div class="layout">
        <aside id="aside-nav" class="layout__aside">
            <section class="aside__user-info">
                <div class="user-info__general">
                    <div class="user-info__container-image">
                        <img src="assets/img/profile.png" class="user-info__image" data-i18n="common.profileAlt"
                            data-i18n-attr="alt" alt="Foto de perfil de Missael Rangel" />
                    </div>
                    <h2 class="user-info__name">Missael Rangel</h2>
                    <h4 class="user-info__job" data-i18n="common.userJob">Desarrollador Web Frontend</h4>
                </div>

                <nav class="layout__menu" data-i18n="common.primaryNav" data-i18n-attr="aria-label"
                    aria-label="Navegación principal">
                    <ul class="menu__list">
                        <li class="menu__option">
                            <a href="index.html" class="menu__link">
                                <i class="menu__icon fa-solid fa-house"></i>
                                <span class="menu__overlay" data-i18n="nav.home">Inicio</span>
                            </a>
                        </li>
                        <li class="menu__option">
                            <a href="sobre-mi.html" class="menu__link">
                                <i class="menu__icon fa-solid fa-user"></i>
                                <span class="menu__overlay" data-i18n="nav.about">Sobre mí</span>
                            </a>
                        </li>
                        <li class="menu__option">
                            <a href="portafolio.html" class="menu__link">
                                <i class="menu__icon fa-solid fa-briefcase"></i>
                                <span class="menu__overlay" data-i18n="nav.portfolio">Portafolio</span>
                            </a>
                        </li>
                        <li class="menu__option">
                            <a href="contacto.html" class="menu__link menu__link--active" aria-current="page">
                                <i class="menu__icon fa-solid fa-envelope"></i>
                                <span class="menu__overlay" data-i18n="nav.contact">Contacto</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <div class="lang-toggle" role="group" data-i18n="common.langToggleLabel" data-i18n-attr="aria-label"
                    aria-label="Selector de idioma">
                    <button type="button" class="lang-toggle__btn" data-lang="es" aria-pressed="false">ES</button>
                    <button type="button" class="lang-toggle__btn" data-lang="en" aria-pressed="false">EN</button>
                </div>

                <div class="user-info__links">
                    <ul class="links__social">
                        <li class="social__option">
                            <a href="https://www.linkedin.com/in/missaelrangel" class="social__link"
                                rel="noopener noreferrer" target="_blank">
                                <i class="social__icon fa-brands fa-linkedin"></i>
                            </a>
                        </li>
                        <li class="social__option">
                            <a href="https://github.com/zpymis" class="social__link" rel="noopener noreferrer"
                                target="_blank">
                                <i class="social__icon fa-brands fa-github"></i>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="user-info__buttons">
                    <a href="assets/Missael_Rangel_Resume.pdf" class="user-info__btn" data-i18n="common.downloadCV"
                        rel="noopener noreferrer" target="_blank">Descargar CV</a>
                </div>

                <footer class="user-info__footer">
                    &copy; 2025 Missael Rangel
                </footer>
            </section>
        </aside>

        <div class="layout__menu-toggle" role="button" tabindex="0" aria-expanded="false" data-i18n-attr="aria-label"
            aria-controls="aside-nav" aria-label="Abrir menú">
            <i class="menu-toggle__icon fa-solid fa-bars"></i>
            <i class="menu-toggle__icon fa-solid fa-xmark"></i>
        </div>

        <main class="layout__content">
            <section class="content__page content__contact">
                <header class="contact__header">
                    <h1 class="contact__title" data-i18n="contact.title">Contacto</h1>
                </header>

                <div class="contact__container">
                    <section class="contact__info">
                        <div class="contact__data">
                            <i class="contact__icon fa-solid fa-location-dot"></i>
                            <h2 class="contact__subtitle" data-i18n="contact.city">Guadalajara</h2>
                        </div>

                        <div class="contact__data">
                            <i class="contact__icon fa-solid fa-phone"></i>
                            <h2 class="contact__subtitle">
                                <a href="tel:+523332458102">3332458102</a>
                            </h2>
                        </div>

                        <div class="contact__data">
                            <i class="contact__icon fa-solid fa-envelope"></i>
                            <h2 class="contact__subtitle">
                                <a href="mailto:missael.rangeel@gmail.com">missael.rangeel@gmail.com</a>
                            </h2>
                        </div>

                        <div class="contact__data">
                            <i class="contact__icon fa-solid fa-circle-check"></i>
                            <h2 class="contact__subtitle" data-i18n="common.userJob">Desarrollador Web Frontend</h2>
                        </div>
                    </section>

                    <section class="contact__form-box">
                        <div class="contact__map" id="load-iframe-map">
                            <span class="loader"></span>
                        </div>

                        <header class="contact__form-header">
                            <h3 class="form-header__title" data-i18n="contact.form.header" data-i18n-html>
                                ¿Cómo puedo <span class="u-accent-strong">ayudarte?</span>
                            </h3>
                        </header>

                        <!-- Netlify Forms + validación custom -->
                        <form class="contact__form" name="contacto" method="POST" data-netlify="true"
                            netlify-honeypot="bot-field" action="gracias.html" novalidate>

                            <!-- Netlify / Honeypot -->
                            <input type="hidden" name="form-name" value="contacto" />
                            <p class="u-hidden" aria-hidden="true">
                                <label>No llenes este campo: <input name="bot-field" tabindex="-1"
                                        autocomplete="off" /></label>
                            </p>

                            <div class="form__container">
                                <section class="form__left">
                                    <div class="form__group">
                                        <!-- NOMBRE -->
                                        <input id="name" type="text" class="form__input" name="name" required
                                            minlength="2" maxlength="80" pattern="[A-Za-zÀ-ÖØ-öø-ÿ.'\- ]{2,}"
                                            title="Escribe tu nombre (solo letras y espacios)." aria-required="true"
                                            data-i18n="contact.form.name" data-i18n-attr="placeholder,aria-label,title"
                                            placeholder="Name" autocomplete="name" />
                                        <label for="name" class="form__label"
                                            data-i18n="contact.form.nameLabel">Name</label>
                                    </div>

                                    <div class="form__group">
                                        <!-- EMAIL -->
                                        <input id="email" type="email" class="form__input" name="email" required
                                            inputmode="email" autocomplete="email" maxlength="254"
                                            pattern="^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?(?:\.[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?)+$"
                                            title="Ingresa un correo válido." aria-required="true"
                                            data-i18n="contact.form.email" data-i18n-attr="placeholder,aria-label,title"
                                            placeholder="Email" />
                                        <label for="email" class="form__label"
                                            data-i18n="contact.form.emailLabel">Email</label>
                                    </div>

                                    <div class="form__group">
                                        <!-- ASUNTO -->
                                        <input id="subject" type="text" class="form__input" name="subject" required
                                            minlength="4" maxlength="120"
                                            title="Escribe un asunto (mínimo 4 caracteres)." aria-required="true"
                                            data-i18n="contact.form.subject"
                                            data-i18n-attr="placeholder,aria-label,title" placeholder="Subject" />
                                        <label for="subject" class="form__label"
                                            data-i18n="contact.form.subjectLabel">Subject</label>
                                    </div>
                                </section>

                                <section class="form__right">
                                    <div class="form__group form__group--textarea">
                                        <!-- MENSAJE -->
                                        <textarea id="message" class="form__input form__input--textarea" name="message"
                                            required minlength="10" maxlength="1000"
                                            title="Cuéntame los detalles de tu proyecto." aria-required="true"
                                            data-i18n="contact.form.message"
                                            data-i18n-attr="placeholder,aria-label,title"
                                            placeholder="Message"></textarea>
                                        <label for="message" class="form__label"
                                            data-i18n="contact.form.messageLabel">Message</label>
                                    </div>
                                </section>
                            </div>

                            <!-- reCAPTCHA de Netlify -->
                            <div class="form__group form__group--captcha">
                                <div data-netlify-recaptcha="true"></div>
                                <p class="form__error" id="recaptchaError" role="alert" aria-live="polite"></p>
                            </div>

                            <input type="submit" class="form__button" data-i18n="contact.form.submit"
                                data-i18n-attr="value" value="Send message" />
                        </form>
                    </section>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... tu código existente arriba (validaciones, etc.) ...

            const captchaWrap = document.querySelector('.form__group--captcha');
            const captchaErr = document.getElementById('recaptchaError');

            // Utilidades
            const T = (key, fb) =>
                (window.i18n && typeof i18n.t === 'function' && i18n.t(key)) || fb;

            function buildMsgs() {
                return {
                    recaptcha: T('contact.form.errors.recaptcha', 'Marca “No soy un robot” antes de enviar.')
                    // (el resto de tus mensajes sigue igual)
                };
            }
            let MSG = buildMsgs();

            function clearCaptchaError() { if (captchaErr) captchaErr.textContent = ''; }

            // ---- Cambio de idioma del CAPTCHA sin recargar la página ----
            async function switchRecaptchaLanguage(lang /* 'en' | 'es' */) {
                try {
                    clearCaptchaError();

                    // 1) Quitar todos los scripts de reCAPTCHA ya cargados
                    document.querySelectorAll('script[src*="recaptcha/api.js"]').forEach(s => s.remove());

                    // 2) Eliminar widget actual y textarea oculta
                    captchaWrap.querySelectorAll('.g-recaptcha, iframe[src*="recaptcha"]').forEach(n => n.remove());
                    captchaWrap.querySelectorAll('.g-recaptcha-response').forEach(n => n.remove());

                    // 3) Reponer el placeholder que Netlify necesita
                    let placeholder = captchaWrap.querySelector('[data-netlify-recaptcha]');
                    if (!placeholder) {
                        placeholder = document.createElement('div');
                        placeholder.setAttribute('data-netlify-recaptcha', 'true');
                        // insértalo antes del <p id="recaptchaError"> si existe, para mantener el orden
                        captchaWrap.insertBefore(placeholder, captchaErr || null);
                    } else {
                        placeholder.innerHTML = '';
                    }

                    // 4) Resetear globals de reCAPTCHA y fijar nuevo idioma
                    try { delete window.grecaptcha; } catch { }
                    try { delete window.__google_recaptcha_client; } catch { }
                    window.___grecaptcha_cfg = window.___grecaptcha_cfg || {};
                    window.___grecaptcha_cfg.lang = (lang === 'en' ? 'en' : 'es');

                    // 5) Cargar el script con el idioma elegido y esperar a que renderice
                    await loadScript('https://www.google.com/recaptcha/api.js?hl=' + (lang === 'en' ? 'en' : 'es'));

                    // 6) Esperar a que aparezca el widget; si no aparece reintentar una vez
                    const appeared = await waitFor(
                        () => captchaWrap.querySelector('.g-recaptcha') || captchaWrap.querySelector('.g-recaptcha-response'),
                        3000
                    );
                    if (!appeared) {
                        // Reintento único (red lenta)
                        await loadScript('https://www.google.com/recaptcha/api.js?hl=' + (lang === 'en' ? 'en' : 'es'));
                        await waitFor(() => captchaWrap.querySelector('.g-recaptcha') || captchaWrap.querySelector('.g-recaptcha-response'), 3000);
                    }
                } catch (err) {
                    // En caso extremo, muestra el mensaje para que el usuario sepa que debe marcar el captcha
                    if (captchaErr) captchaErr.textContent = MSG.recaptcha;
                }
            }

            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const s = document.createElement('script');
                    s.src = src;
                    s.async = true;
                    s.defer = true;
                    s.onload = resolve;
                    s.onerror = reject;
                    document.body.appendChild(s);
                });
            }
            function waitFor(testFn, timeout = 2000, interval = 50) {
                return new Promise(resolve => {
                    const start = Date.now();
                    (function tick() {
                        if (testFn()) return resolve(true);
                        if (Date.now() - start > timeout) return resolve(false);
                        setTimeout(tick, interval);
                    })();
                });
            }

            // ---- Hook al toggle de idioma (NO recargamos la página) ----
            document.querySelectorAll('.lang-toggle__btn[data-lang]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const newLang = btn.dataset.lang === 'en' ? 'en' : 'es';
                    // deja que i18n.js actualice textos primero
                    setTimeout(async () => {
                        MSG = buildMsgs();
                        await switchRecaptchaLanguage(newLang);
                    }, 0);
                });
            });

            // ... tu código existente debajo (submit, validaciones, etc.) ...
        });
    </script>
</body>

</html>