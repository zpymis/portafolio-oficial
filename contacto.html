<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <title data-i18n="meta.contact.title">Contacto — Missael Rangel</title>
    <meta name="description" data-i18n="meta.contact.description" data-i18n-attr="content" />

    <script>
        (function () {
            var k = "site:lang";
            var saved = null;
            try { saved = localStorage.getItem(k); } catch (e) { }
            var nav = (navigator.language || "es").toLowerCase();
            var lang = (saved === "en" || saved === "es") ? saved : (nav.startsWith("es") ? "es" : "en");
            document.documentElement.classList.add("lang-" + lang);
        })();
    </script>

    <!-- Estilos -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32x32.png" />
    <link rel="stylesheet" href="assets/fonts/fontawesome-free-6.1.2-web/css/all.min.css" />
    <link rel="stylesheet" href="assets/fonts/poppins/poppins.css" />
    <link rel="stylesheet" href="assets/css/reset.css" />
    <link rel="stylesheet" href="assets/css/scroll.css" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/loader.css" />
    <link rel="stylesheet" href="assets/css/responsive.css" />

    <!-- i18n -->
    <script defer src="assets/js/translations.js"></script>
    <script defer src="assets/js/i18n.js"></script>

    <!-- Scripts -->
    <script defer src="assets/js/menu.js"></script>
    <script defer src="assets/js/map.js"></script>
</head>

<body>
    <div class="layout">
        <aside id="aside-nav" class="layout__aside">
            <section class="aside__user-info">
                <div class="user-info__general">
                    <div class="user-info__container-image">
                        <img src="assets/img/profile.png" class="user-info__image" data-i18n="common.profileAlt"
                            data-i18n-attr="alt" alt="Foto de perfil de Missael Rangel" />
                    </div>
                    <h2 class="user-info__name">Missael Rangel</h2>
                    <h4 class="user-info__job" data-i18n="common.userJob">Desarrollador Web Frontend</h4>
                </div>

                <nav class="layout__menu" data-i18n="common.primaryNav" data-i18n-attr="aria-label"
                    aria-label="Navegación principal">
                    <ul class="menu__list">
                        <li class="menu__option">
                            <a href="index.html" class="menu__link">
                                <i class="menu__icon fa-solid fa-house"></i>
                                <span class="menu__overlay" data-i18n="nav.home">Inicio</span>
                            </a>
                        </li>
                        <li class="menu__option">
                            <a href="sobre-mi.html" class="menu__link">
                                <i class="menu__icon fa-solid fa-user"></i>
                                <span class="menu__overlay" data-i18n="nav.about">Sobre mí</span>
                            </a>
                        </li>
                        <li class="menu__option">
                            <a href="portafolio.html" class="menu__link">
                                <i class="menu__icon fa-solid fa-briefcase"></i>
                                <span class="menu__overlay" data-i18n="nav.portfolio">Portafolio</span>
                            </a>
                        </li>
                        <li class="menu__option">
                            <a href="contacto.html" class="menu__link menu__link--active" aria-current="page">
                                <i class="menu__icon fa-solid fa-envelope"></i>
                                <span class="menu__overlay" data-i18n="nav.contact">Contacto</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <div class="lang-toggle" role="group" data-i18n="common.langToggleLabel" data-i18n-attr="aria-label"
                    aria-label="Selector de idioma">
                    <button type="button" class="lang-toggle__btn" data-lang="es" aria-pressed="false">ES</button>
                    <button type="button" class="lang-toggle__btn" data-lang="en" aria-pressed="false">EN</button>
                </div>

                <div class="user-info__links">
                    <ul class="links__social">
                        <li class="social__option">
                            <a href="https://www.linkedin.com/in/missaelrangel" class="social__link"
                                rel="noopener noreferrer" target="_blank">
                                <i class="social__icon fa-brands fa-linkedin"></i>
                            </a>
                        </li>
                        <li class="social__option">
                            <a href="https://github.com/zpymis" class="social__link" rel="noopener noreferrer"
                                target="_blank">
                                <i class="social__icon fa-brands fa-github"></i>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="user-info__buttons">
                    <a href="assets/Missael_Rangel_Resume.pdf" class="user-info__btn" data-i18n="common.downloadCV"
                        rel="noopener noreferrer" target="_blank">Descargar CV</a>
                </div>

                <footer class="user-info__footer">
                    &copy; 2025 Missael Rangel
                </footer>
            </section>
        </aside>

        <div class="layout__menu-toggle" role="button" tabindex="0" aria-expanded="false" data-i18n-attr="aria-label"
            aria-controls="aside-nav" aria-label="Abrir menú">
            <i class="menu-toggle__icon fa-solid fa-bars"></i>
            <i class="menu-toggle__icon fa-solid fa-xmark"></i>
        </div>

        <main class="layout__content">
            <section class="content__page content__contact">
                <header class="contact__header">
                    <h1 class="contact__title" data-i18n="contact.title">Contacto</h1>
                </header>

                <div class="contact__container">
                    <section class="contact__info">
                        <div class="contact__data">
                            <i class="contact__icon fa-solid fa-location-dot"></i>
                            <h2 class="contact__subtitle" data-i18n="contact.city">Guadalajara</h2>
                        </div>

                        <div class="contact__data">
                            <i class="contact__icon fa-solid fa-phone"></i>
                            <h2 class="contact__subtitle">
                                <a href="tel:+523332458102">3332458102</a>
                            </h2>
                        </div>

                        <div class="contact__data">
                            <i class="contact__icon fa-solid fa-envelope"></i>
                            <h2 class="contact__subtitle">
                                <a href="mailto:missael.rangeel@gmail.com">missael.rangeel@gmail.com</a>
                            </h2>
                        </div>

                        <div class="contact__data">
                            <i class="contact__icon fa-solid fa-circle-check"></i>
                            <h2 class="contact__subtitle" data-i18n="common.userJob">Desarrollador Web Frontend</h2>
                        </div>
                    </section>

                    <section class="contact__form-box">
                        <div class="contact__map" id="load-iframe-map">
                            <span class="loader"></span>
                        </div>

                        <header class="contact__form-header">
                            <h3 class="form-header__title" data-i18n="contact.form.header" data-i18n-html>
                                ¿Cómo puedo <span class="u-accent-strong">ayudarte?</span>
                            </h3>
                        </header>

                        <!-- Netlify Forms + validación custom -->
                        <form class="contact__form" name="contacto" method="POST" data-netlify="true"
                            netlify-honeypot="bot-field" action="gracias.html" novalidate>
                            <!-- Netlify -->
                            <input type="hidden" name="form-name" value="contacto" />
                            <p class="u-hidden" aria-hidden="true">
                                <label>No llenes este campo: <input name="bot-field" tabindex="-1"
                                        autocomplete="off" /></label>
                            </p>

                            <div class="form__container">
                                <section class="form__left">
                                    <div class="form__group">
                                        <!-- NOMBRE -->
                                        <input id="name" type="text" class="form__input" name="name" required
                                            minlength="2" maxlength="80" pattern="[A-Za-zÀ-ÖØ-öø-ÿ.'\- ]{2,}"
                                            title="Escribe tu nombre (solo letras y espacios)." aria-required="true"
                                            data-i18n="contact.form.name" data-i18n-attr="placeholder,aria-label,title"
                                            placeholder="Name" autocomplete="name" />
                                        <label for="name" class="form__label"
                                            data-i18n="contact.form.nameLabel">Name</label>
                                    </div>

                                    <div class="form__group">
                                        <!-- EMAIL -->
                                        <input id="email" type="email" class="form__input" name="email" required
                                            inputmode="email" autocomplete="email" maxlength="254"
                                            pattern="^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?(?:\.[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?)+$"
                                            title="Ingresa un correo válido." aria-required="true"
                                            data-i18n="contact.form.email" data-i18n-attr="placeholder,aria-label,title"
                                            placeholder="Email" />
                                        <label for="email" class="form__label"
                                            data-i18n="contact.form.emailLabel">Email</label>
                                    </div>

                                    <div class="form__group">
                                        <!-- ASUNTO -->
                                        <input id="subject" type="text" class="form__input" name="subject" required
                                            minlength="4" maxlength="120"
                                            title="Escribe un asunto (mínimo 4 caracteres)." aria-required="true"
                                            data-i18n="contact.form.subject"
                                            data-i18n-attr="placeholder,aria-label,title" placeholder="Subject" />
                                        <label for="subject" class="form__label"
                                            data-i18n="contact.form.subjectLabel">Subject</label>
                                    </div>
                                </section>

                                <section class="form__right">
                                    <div class="form__group form__group--textarea">
                                        <!-- MENSAJE -->
                                        <textarea id="message" class="form__input form__input--textarea" name="message"
                                            required minlength="10" maxlength="1000"
                                            title="Cuéntame los detalles de tu proyecto." aria-required="true"
                                            data-i18n="contact.form.message"
                                            data-i18n-attr="placeholder,aria-label,title"
                                            placeholder="Message"></textarea>
                                        <label for="message" class="form__label"
                                            data-i18n="contact.form.messageLabel">Message</label>
                                    </div>
                                </section>
                            </div>

                            <!-- reCAPTCHA de Netlify -->
                            <div class="form__group form__group--captcha">
                                <div data-netlify-recaptcha="true"></div>
                                <p class="form__error" id="recaptchaError" role="alert" aria-live="polite"></p>
                            </div>

                            <input type="submit" class="form__button" data-i18n="contact.form.submit"
                                data-i18n-attr="value" value="Send message" />
                        </form>
                    </section>
                </div>
            </section>
        </main>
    </div>

    <!-- Validación i18n + control de reCAPTCHA + carga del captcha con idioma actual -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('.contact__form');
            if (!form) return;

            const submitBtn = form.querySelector('.form__button');
            const captchaWrap = form.querySelector('.form__group--captcha');

            const T = (key, fb) =>
                (window.i18n && typeof i18n.t === 'function' && i18n.t(key)) || fb;

            const currentLang = () =>
                (window.i18n && typeof i18n.current === 'function' && i18n.current()) ||
                document.documentElement.getAttribute('lang') || 'es';

            function buildMsgs() {
                return {
                    name: T('contact.form.errors.name', 'Escribe tu nombre (solo letras y espacios, mínimo 2).'),
                    email: T('contact.form.errors.email', 'Ingresa un email válido.'),
                    subject: T('contact.form.errors.subject', 'Escribe un asunto (mínimo 4 caracteres).'),
                    message: T('contact.form.errors.message', 'Escribe un mensaje (mínimo 10 caracteres).'),
                    default: T('contact.form.errors.default', 'Completa este campo.'),
                    recaptcha: T('contact.form.errors.recaptcha', 'Marca “No soy un robot” antes de enviar.')
                };
            }
            let MSG = buildMsgs();

            const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;

            function validateField(el) {
                const v = (el.value || '').trim();
                let msg = '';

                if (el.required && !v) {
                    msg = MSG.default;
                } else {
                    switch (el.id) {
                        case 'name': if (v.length < 2) msg = MSG.name; break;
                        case 'email': if (!EMAIL_RE.test(v)) msg = MSG.email; break;
                        case 'subject': if (v.length < 4) msg = MSG.subject; break;
                        case 'message': if (v.length < 10) msg = MSG.message; break;
                    }
                }
                el.setCustomValidity(msg);
                return !msg;
            }

            form.querySelectorAll('input[required], textarea[required]').forEach(el => {
                el.addEventListener('input', () => validateField(el));   // no bloquea navegación entre campos
                el.addEventListener('blur', () => { if (!validateField(el)) el.reportValidity(); });
            });

            function captchaResponse() {
                try {
                    if (window.grecaptcha && typeof grecaptcha.getResponse === 'function') {
                        return grecaptcha.getResponse();
                    }
                    const t = document.querySelector('.g-recaptcha-response');
                    return t ? t.value : '';
                } catch { return ''; }
            }

            let captchaErrorEl = null;
            function showCaptchaError() {
                if (!captchaErrorEl) {
                    captchaErrorEl = document.createElement('p');
                    captchaErrorEl.className = 'form__error';
                    captchaWrap.appendChild(captchaErrorEl);
                }
                captchaErrorEl.textContent = MSG.recaptcha;
            }
            function clearCaptchaError() {
                if (captchaErrorEl) captchaErrorEl.textContent = '';
            }

            form.addEventListener('submit', (e) => {
                clearCaptchaError();
                const fields = Array.from(form.querySelectorAll('input[required], textarea[required]'));
                let firstInvalid = null;
                fields.forEach(el => { if (!validateField(el) && !firstInvalid) firstInvalid = el; });

                if (firstInvalid) {
                    e.preventDefault();
                    firstInvalid.reportValidity();
                    firstInvalid.focus();
                    return;
                }
                if (!captchaResponse()) {
                    e.preventDefault();
                    showCaptchaError();
                    captchaWrap.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                submitBtn?.setAttribute('disabled', 'true');
            });

            // ---------- SOLO reCAPTCHA dinámico (sin recargar la página) ----------
            function loadRecaptchaScript(lang) {
                // Elimina scripts previos
                document.querySelectorAll('script[src*="/recaptcha/api.js"]').forEach(s => s.remove());
                // Limpia widget y textarea oculto
                captchaWrap.querySelectorAll('.g-recaptcha, iframe[src*="recaptcha"]').forEach(n => n.remove());
                captchaWrap.querySelectorAll('.g-recaptcha-response').forEach(n => n.remove());
                // Asegura el placeholder de Netlify
                let placeholder = captchaWrap.querySelector('[data-netlify-recaptcha]');
                if (!placeholder) {
                    placeholder = document.createElement('div');
                    placeholder.setAttribute('data-netlify-recaptcha', 'true');
                    captchaWrap.appendChild(placeholder);
                } else {
                    placeholder.innerHTML = '';
                }
                // Carga script en el idioma deseado; Netlify lo renderiza automáticamente
                const s = document.createElement('script');
                s.src = 'https://www.google.com/recaptcha/api.js?hl=' + (lang === 'en' ? 'en' : 'es');
                s.async = true;
                s.defer = true;
                document.body.appendChild(s);
            }

            // Carga inicial del reCAPTCHA en el idioma actual (por si el HTML no lo trajo)
            (function ensureRecaptcha() {
                const hasScript = Array.from(document.scripts).some(s => (s.src || '').includes('/recaptcha/api.js'));
                if (!hasScript) loadRecaptchaScript(currentLang());
            })();

            // --------- Cambio de idioma SIN recargar (mantiene mapa e inputs) ---------
            document.querySelectorAll('.lang-toggle__btn[data-lang]').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Deja que i18n.js cambie textos/atributos primero
                    setTimeout(() => {
                        // Actualiza mensajes de validación al nuevo idioma
                        MSG = buildMsgs();
                        clearCaptchaError();
                        // Re-pinta ÚNICAMENTE el reCAPTCHA en el nuevo idioma
                        const newLang = (btn.dataset.lang === 'en') ? 'en' : 'es';
                        loadRecaptchaScript(newLang);
                        // Importante: NO recargamos la página → se conservan mapa e inputs
                    }, 0);
                });
            });
        });
    </script>


    <!-- Shadow form para detección de Netlify -->
    <form name="contacto" netlify netlify-honeypot="bot-field" hidden>
        <input type="text" name="name" />
        <input type="email" name="email" />
        <input type="text" name="subject" />
        <textarea name="message"></textarea>
    </form>
</body>

</html>